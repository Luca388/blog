---
layout: post
categories: OS
title: 프로세스와 스레드
---
# 프로세스
보조기억 장치에  저장된 프로그램을 메모리에 적재하고 실행하는 순간 프로그램은 프로세스가 된다(실행중인 프로그램)

사용자가 보는 앞에서 실행되는 프로세스는 **포그라운드 프로세스**라고 하고 그 반대는 **백그라운드 프로세스**라고 한다.

부팅때 자동으로 켜지고 사용자와 상호작용하지않는 백그라운드 프로세스를 UNIX계열에서는 damon이라 부르고 Windows에서는 Service 라고 부른다.
# 프로세스 제어 블록 (PCB)
프로세스와 관련된 정보를 저장하는 자료 구조.

PCB는 프로세스 생성 시에 만들어지고 실행이 끝나면 폐기된다. (프로세스 생성 == PCB 생성)

PCB는 커널 영역에 생성된다.
## PID
프로세스 ID는 특정 프로세스를 식별하기 위해 부여하는 고유한 번호이다. 모든 프로세스는 PID가 다르다.
## value of Register
프로세스는 자신의 실행 차례가 돌아오면 이전까지 사용했던 레지스터의 중간값을 모두 복원한다.

PCB에는 해당 프로세스가 실행하며 사용했던 프로그램 카운터를 비롯한 레지스터 값이 담긴다.
## Status of Process
현제 프로세스의 상태 정보가 저장된다.
## CPU 스케줄링 정보
프로세스가 언제,어떤 순서로 CPU를 할당받을지에 대한 정보가 저장된다.
## 메모리 관리 정보
페이지테이블,프로세스가 어느 주소에 저장되어있는지 등등.
## 사용한 파일과 입출력 장치 목록
프로세스가 실행 과정에서 특정 입출력 장치나 파일을 사용하면 PCB에 해당 정보가 명시된다.

# 문맥 교환

> 하나의 프로세스 수행을 재개하기 위해 기억해야 할 정보를 문맥 이라고 한다,이러한 문맥은 해당 프로세스의 PCB에 표현되어있다. 즉 PCB 에 기록되는 정보들을 문맥이라 봐도 무방하다.

기존 프로세스의 문맥을 PCB에 백업하고,새로운 프로세스를 실행하기 위해 문맥을 PCB로  부터 복구하여 새로운 프로세스를 실행하는것을 **문맥 교환**이라고 한다.

# 프로세스의 메모리 영역
프로세스는 사용자 영역에 크게 Code segment,Data segment , heap segment, Stack segment 으로 나뉘어 저장된다.

> code segment 와 data segment 는 크기가 고정된 영역이라는 점에서 정적 할당 영역 이라고 부른다.
heap segment 와 stack segment는 프로세스 실행 과정에서 그 크기가 변할수 있으므로 동적 할당 영역이라고 부른다.

## Code segment (Text segment)
실행할수 있는 코드, 기계어로 이루어진 명령어가 저장된다. 쓰기 금지 구역이며 read-only 공간이다.
## Data segment
잠깐 썼다가 없앨 데이터가 아닌 프로그램이 실행되는 동안 유지할 데이터가 저장되는 공간이다.

전역변수가 대표적이다.

##  heap segment
개발자가 직접 할당할수 있는 저장 공간 이다.

## stack segment 
데이터를 일시적으로 저장하는 영역이다.

# 프로세스 상태와 계층 구조 

## 생성상태(new)
프로세스를 생성 중인 상태를 생성 상태(new)라고 한다. 이제 막 메모리에 적재되어 PCB를 할당받은 상태를 말하며 생성상태를 거쳐 실행할 준비가 완료된 프로세스는 곧바로 실행되지 않고 준비 상태가 되어 CPU의 할당을 기다린다.
## 준비상태(ready)
당장이라도 CPU를 할당받아 실행할 수 있지만, 아직 자신의 차례가 아니기에 기다리고 있는 상태이다.준비 상태 프로세스는 차례가 되면 CPU를 할당받아 실행 상태가 된다.
> 준비 상태인 프로세스가 실행 상태로 전환되는것을 dispatch라고 한다.

## 실행상태 (running)
실행상태는 CPU를 할당받아 실행 중인 상태를 말한다.실행 상태인 프로세스는 할당된 일정 시간 동안만 CPU를 사용할수 있으며 프로세스가 할당된 시간을 모두 사용한다면(타이머 인터럽트가 발생하면) 다시 준비 상태가 되고,
실행 도중 입출력 장치를 사용하여 입출력 장치의 작업이 끝날때까지 기다려야한다면 대기 상태가 된다.
## 종료상태 (terminated)
종료 상태는 프로세스가 종료된 상태이다.프로세스가 종료되면 운영체제는 PCB와 프로세스가 사용한 메모리를 정리한다.

>> process status diagram 참조

# 프로세스 계층 구조
프로세스는 실행 도중 시스템 콜을 통해 다른 프로세스를 생성할 수 있다. 이때 새 프로세스를 생성한 프로세스를 부모 프로세스 ,부모 프로세스에 의해 생성된 프로세스를 자식 프로세스라고 한다.
부모와 자식 프로세스는 다른 프로세스이기에 각기 다른 PID를 가진다.일부 운영체제에서는 자식 프로세스의 PCB에 부모 프로세스의 PID인 PPID(Parent PID)를 기록하기도 한다.

프로세스가 프로세스를 낳는 과정을 도표로 그리면 트리구조를 띄는데 이걸 프로세스 계층 구조라고 한다.

> 최초의 프로세스  유닉스에서는 init 리눅스에서는 systemd mac os 에서는  launchd 이다. 최초의 프로세스 PID는 항상 1번이며 모든 프로세스 최상단에 있는  부모 프로세스이다.

# 프로세스 생성 기법 
부모 프로세스는 fork 를 통해 자식 프로세스를 생성하고 자식 프로세스는 exec 를 통해 자신의 메모리 공간을 다른 프로그램으로 교체한다.
fork와 exec는 시스템 호출 이며 부모 프로세스는 fork를 통해 자신의 복사본을 자식 프로세스로 생성한다 자식 프로세스는 부모 프로세스의 복사본이기 떄문에 PID값이나 저장된 메모리 위치를 제외하고 자원,메모리 내용, 열린 파일의 목록등이 상속된다.

fork를 통해 복사본이 만들어진뒤에 자식 프로세스는 exec 시스템 호출을 통해 새로운 프로그램으로 전환된다.exec는 자신의 메모리 공간을 새로운 프로그램으로 덮어쓴느 시스템 호출이다.

exec 시스템 콜을 하면 코드 영역과 데이터 영역의 내용이 실행할 프로그램의 내용으로 바뀌고, 나머지 영역은 초기화 된다.

부모 프로세스가 자식 프로세스를 fork한 뒤에 부모 프로세스 , 자식 프로세스 누구도 exec 를 호출하지 않는 경우도 있다. 이경우에는 부모 프로세스와 자식 프로세스는 같은 코드를 병행하여 실행하는 프로세스가 된다.


# 스레드(thread)
프로세스를 구성하는 실행의 흐름단위 (소프트웨어 스레드)

프로세스가 하나의 실행 흐름을 가지는 프로세스를 *단일 스레드 프로세스* 라고 부른다.

스레드는 '프로세스를 구성하는 실행 단위'라고 볼수 있다.스레드는 프로세스 내에서 각기 다른 스레드 ID ,프로그램 카운터 값을 비롯한 레지스터 값,스택으로 구성된다.그러므로 스레드마다 각기 다른 코드를 실행할수 있다.

프로세스의 스레드들은 실행에 필요한 최소한의 정보(프로그램 카운터 값을 비롯한 레지스터 값,스택)만을 유지한 채 **프로세스의 자원을 공유** 하며 실행된다.


# 멀티프로세스와 멀티 스레드
여러 프로세스를 동시에 실행하는것을 **멀티프로세스**라고 하고 여러스레드로 프로세스를 동시에 실행하는 것을 **멀티스레드**라고 한다.

멀티프로세스와 멀티스레드의 차이점은 자원을 공유한다는것에 중점이 있다.
멀티 프로세스에서 프로세스는 기본적으로 자원을 공유하지 않지만,스레드끼리는 자원을 공유한다.같은 프로그램을 실행하기위해 멀티프로세스를 하면 메모리에 동일한 내용들이 중복해서 올라가고 멀티스레드는 각기 다른 스레드 ID,프로그램 카운터 값을 비롯한 레지스터 값,스택을 가질뿐 프로세스가 가지고 있는 자원을 공유한다. 이러므로 멀티 스레드가 메모리를 효율적으로 사용할수 있다는 장점이있다. 다만 멀티스레드 환경에서는 하나의 스레드에 문제가 생기면 프로세스 전체에 문제가 생길수 있다.

>프로세스간 통신  프로세스끼리는 기본적으로 자원을 공유하지않지만 프로세스끼리도 충분히 자원을 공유하고 데이터를 주고받을수 있다.이러한 프로세스간의 자원을 공유하고 데이터를 주고받는것을 **프로세스 간 통신(IPC)**
라고 부른다. 가령 프로세스 a와 b가 a.txt라는 파일에 값을쓰는 프로세스,값을 읽는 프로세스라면 두 프로세스는 a.txt라는 파일 속 데이터를 주고받으므로 파일을 통한 IPC라고 할수 있다.
또 프로세스들은 서로 공유하는 메모리 영역을 두어 데이터를 주고받을수 있다 .이러한 영역을 *공유 메모리* 라고 한다.