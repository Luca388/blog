---
layout: post
categories: OS
title: 가상 메모리
---
# 연속 메모리 할당
>프로세스를 연속적인 메모리 공간에 할당하는 방식

# 스와핑
>입출력 작업의 요구로 대기 상태가 된 프로세스,오랫동안 사용되지 않는 프로세스,현재 실행되지 않는 프로세스들을 임시로 보조기억장치 일부 영역(스왑영역)으로 쫒아내고,그렇게 해서 생긴 메모리상의 빈 공간에 또 다른 프로세스를 적재하여 실행하는 방식.

- 스왑영역
> 프로세스들이 쫒겨나는 보조기억장치의 일부 영역.
- 스왑아웃
>현재 실행되지 않는 프로세스가 메모리에서 스왑 영역으로 옮겨지는 것.
- 스왑 인
> 스왑영역에 있던 프로세스가 다시  메모리로 옮겨오는 것.

>스왑 아웃 되었던 프로세스가 스왑 인 되면 이전의 물리 주소와는 다른 주소에 적재될수 있다.

# 메모리 할당
최초 적합,최적 적합,최악 적합.
## first fit
운영체제가 메모리 내의 빈 공간을 순서대로 검색하다가 적재할 수 있는 공간을 발견하면 그 공간에 프로세스를 배치하는 방식
>프로세스가 적재될수 있는 공간을 발견하는 즉시 메모리를 할당하는 방식이므로 검색을 최소화 할수 있고 결과적으로 빠른할당이 가능하다

## best fit
운영체제가 빈 공간을 모두 검색해 본후 , 프로세스가 적재될 수 있는 공간 중 가장 작은 공간에 프로세스를 배치하는 방식.
## worst fit
운영체제가 빈 공간을 모두 검색해 본후 , 프로세스가 적재될 수 있는 공간 중 가장 큰 공간에 프로세스를 배치하는 방식.

# 외부 단편화 (external fragmentation)
프로세스를 할당하기 어려울 만큼 작은 메모리 공간들로 인해 메모리가 낭비되는 현상
## compaction (압축)
여기저기 흩어져 있는 빈 공간들을 하나로 모으는 방식,메모리 내에 저장된 프로세스를 적당히 재배치시켜 여기저기 흩어져 있는 작은 빈 공간들을 하나의 큰 빈 공간으로 만드는 방법

> 단점: 작은 빈 공간들을 하나로 모으는 동안 시스템은 하던 일을 중지해야하고 메모리에 있는 내용을 옮기는 작업은 많은 오버헤드를 야기하며 어떤 프로세스를 어떻게 움직여야 오버헤드를 최소화 하며 압축할 수 있는지에 대한 명확한 방법을 결정하기가 어렵다.

---
# 가상 메모리
실행하고자 하는 프로그램을 일부만 메모리에 적재하여 실제 물리 메모리 크기보다 더 큰 프로세스를 실행할 수 있게 하는 기술.

>관리 기법에는 크게 페이징과 세그멘테이션이 있다.


# 페이징
프로세스의 논리 주소 공간을 페이지라는 일정한 단위로 자르고,메모리 물리 주소 공간을 frame이라는 페이지와 동일한 크기의 일정한 단위로 자른뒤 페이지를 프레임에 할당하는 가상 메모리 관리 기법.
## 페이지 아웃
페이징 시스템에서의 스왑아웃이다.페이지 단위로 스왑 아웃된다
## 페이지 인
페이징 시스템에서의 스왑 인 이다. 페이지 단위로 스왑 인된다.

# 페이지 테이블
프로세스가 물리 주소에 불연속적으로 배치되더라도 논리 주소에는 연속적으로 배치되도록 해준다.

페이지 번호와 프레임 번호를 짝지어 주는 일종의 이정표 이며 cpu로 하여금 페이지 번호만 보고 해당 페이지가 적재된 프레임을 찾을 수 있게 해준다.

다시 말해 페이지 테이블은 현재 어떤 페이지가 어떤 프레임에 할당되었는지를 알려준다.

> 내부단편화: 프로세스 크기가 페이지의 배수 가 아닐떄 생기는 메모리 낭비,하나의 페이지 크기보다 작은 크기일떄 발생

프로세스마다 각자의 프로세스 테이블을 가지고 있고 각 프로세스의 페이지 테이블들은 메모리에 적재되어있다.그리고 cpu내의 **Page Table Base Register (PTBR)**
는 각 프로세스의 페이지 테이블이 적재된 주소를 가리키고있다.

> 각 프로세스의 페이지 테이블 정보들은 각 프로세스의 pcb에 기록된다.문맥교환이 일어 날떄 같이 변경.

## TLB(Translation Lookaside Buffer)
메모리에 두번 접근을 피하기 위해  CPU 곁에(일반적으로 MMU 내에 ) TLB 라는 페이지 테이블의 캐시 메모리를 둔다.
참조 지역성에 근거해 주로 최근에 사용된 페이지 위주로 가져와 저장한다.

> TLB 히트는 cpu가 발생한 논리 주소에 대한 페이지 번호가 TLB에 있을 경우이고 그 반대는 TLB 미스 라고한다.


# 페이징에서의 주소 변환
페이지 혹은 프레임은 여러 주소를 포괄하고 있다.특정주소에 접근할라면 
- 어떤 페이지 혹은 프레임에 접근하고 싶은지
- 접근하려는 주소가 그 페이지 혹은 프레임으로부터 얼마나 떨어져 있는지

에 대한 정보가 필요하다

그렇기에 페이징 시스템에서는 모든 논리 주소가 기본적으로 page number 와 offset 으로 이루어져있다 가령 cpu가 32 비트 주소를 내보냈다면 이중 n 비트는 페이지 번호,32-n비트는 변위 이런식이다.

페이지 번호는 말 그대로 페이지 번호이며 해당 페이지 번호가 어떤 프레임에 할당되었는지를 알수 있다 변위는 접근하려는 주소가 프레임의 시작 번지로부터 얼만큼 떨어져 있는지를 알기 위한 정보이다. 

논리주소 <페이지 번호,변위는>는 페이지 테이블을 통해 물리 주소 <프레임 번호,변위>로 변환된다

# 페이지 테이블 엔트리 (PTE : Page Table Entry)
페이지 테이블 엔트리에 담기는 정보로 페이지 번호,프레임번호도 있지만, 대표적으로 유효 비트,보호 비트 ,참조 비트,수정비트가 있다
## valid bit
유효비트는 현재 해당 페이지에 접근 가능한지 여부를 알려준다.PTE에서 프레임 번호 다음으로 중요한 정보라고도 볼수있다.

유효 비트는 현재 페이지가 메모리에 적재되어 있는지 아니면 보조기억장치에 있는지를 알려주는 비트이다

페이지가 메모리에 적재되어있다면 1 ,적재되어있지 않다면 0이다.

유효비트가 0인 메모리에 적재되어있지 않은 페이지로 접근하려고하면 **page fault** 예외가 발생한다.

페이지폴드를 처리하는 과정은 하드웨어 인터럽트를 처리하는 과정과 유사하다.

## protection bit
페이지 보호 기능을 위해서 존재하는 비트이다. 페이지에 접근할 권한을 제한하여 페이지를 보호하는 비트이다.

해당 페이지가 읽기 쓰기 실행이 가능한 페이지인지를 나타낸다.
## reference bit
cpu가 이 페이지에 접근한적이 있는지의 여부를 나타낸다.적재이후 cpu가 읽거나 쓴 페이지는 참조 비트가 1로 세팅되거 ,한번도 읽기쓰기를 안한페이지는 0으로 유지된다.
## modified bit(dirty bit)
해당 페이지에 데이터를 쓴 적이 있는지 없는지 수정 여부를 알려준다.

이 비트가 1이면 변겨오딘 적이 있는 페이지 0이면 변경된 적이 없는 페이지이다.

수정 비트는 페이지가 메모리에서 사라질때 보조기억 장치에 쓰기 작업을 해야하는지,할필요가 없는지를 판단하기 위해 존재한다.

수정비트가 1이면 보조기억장치와 메모리의 페이지 내용이 서로 다르므로  페이지가 스왑 아웃될경우  변경된 값을 보조기억장치에 기록하는 작업이 필요하다. 수정 비트가 0이면 아무런 추가 작업 없이 새로 적재된 페이지로 덮어쓰기하면 된다.

# copy on write
부모 프로세스와 동일한 자식 프로세스가 생성되면  자식 프로세스로 하여금 부모 프로세스와 동일한 프레임을 가리킨다.만일 부모 와 자식 프로세스가 메모리에 어떤한 데이터도 쓰지 않고 그저 읽기작업만 한다면 상태가 지속되고,부모 및 자식 둘중 하나가 쓰기
작업을 한다면 그순간 해당 페이지가 별도의 공간으로 복제된다. 

> 이러한 쓰기 시 복사를 통해 프로세스 생성시간을 줄이는것과 메모리 공간 절약이 가능하다.

# hierarchical paging
계층적 페이징은 페이지 테이블을 페이징하여 여러 단계의 페이지를 두는 방식이다. 여러단계의 페이지를 둔다는 점에서 multilevel page table 기법이라고 부르기도한다.

프로세스의 페이지 테이블을 여러개의 페이지로 자르고,바깥쪽에 페이지 테이블을 하나 더 두어 잘린 페이지 테이블의 페이지들을 가르키는 방식이다.

이러한 outer page table은 항상 메모리에 유지해야한다.

계층적 페이징을 사용시 cpu가 발생하는 논리 주소는 |바깥페이지 번호|안쪽페이지 번호|변위| 같은 형태로 만들어진다

바깥페이지 테이블 번호를 통해 페이지 테이블의 페이지를 찾고 페이지테이블의 페이지를 통해 프레임 변호를 찾고 변위를 더함 으로서 물리주소를 찾는다

계층은 2단계 이상이 될수 있다.

결국 포인터이다.

# 페이지 교체와 프레임 할당
## demand paging 
프로세스를 메모리에 적재할떄 처음부터 모든 페이지를 적재하지 않고 필요한 페이지만을 메모리에 적재하는 기법.

- cpu가 특정 페이지에 접근하는 명령어를 실행
- 해당페이지가 현재 메모리에 있을경우(유효비트가 1일경우) cpu는 페이지가 적재된 프레임에 접근한다.
- 해당 페이지가 현재 메모리에 없을 경우(유효 비트가 0일 경우) 페이지 폴트가 발생한다.
- 페이지 폴트 처리 루틴은 해당 페이지를 메모리로 적재하고 유효 비트를 1 로 설정한다
- 다시 1번쨰를 실행한다.

## pure demand paging
아무런 페이지도 메모리에 적재하지 않은 채 무작정 실행을 할수 있다.

이 경우 프로세스의 첫 명령어를 실행하는 순간부터 페이지 폴트가 계속 발생하게 되고, 실행에 필요한 페이지가 어느 정도 적재된 이후부터는 페이지 폴트 발생 빈도가 떨어진다.

이를 순수 요구 페이징 이라고 한다.

---
요구 페이징 시스템이 안정적으로 작동하려면 필연적으로 다음 두가지를 해결해야한다

- 페이지 교체
- 프레임 할당

# 페이지 교체 알고리즘
실행에 필요한 페이지를 적재하기 위해 메모리에 적재된 페이지를 보조 기억 장치로 내보내는 알고리즘.

즉, 쫒아낼 페이지를 결정하는 방법이다.

좋은 페이지 교체 알고리즘은 페이지 폴트를 가장 적게 일으키는 알고리즘이다.

페이지 교체 알고리즘을 제대로 이해하려면 페이지 폴트 횟수를 알수 있어야한다 그리고 페이지 폴트 횟수는 page reference string을 통해 알수 있다

페이지 참조열은 cpu가 참조하는 페이지들 중 연속된 페이지를 생략한 페이지열을 의미한다

예를 들어 cpu가  '2 2 2 3 5 5 5 3 3 7' 과 같은 순서로 페이지에 접근했으면 여기서 연속된 페이지를 생략한 페이지열은 '2 3 5 3 7'이다.

## FIFO 페이지 교체 알고리즘
가장 먼저 올라온 페이지부터 내쫒는 방식
## second chance page replacement algorithm
fifo 알고리즘과 같지만 참조비트를 참조해 기회를 2번 주는 알고리즘
## optimal page replacement algorithm
앞으로의 사용 빈도가 가장 낮은 페이지를 교체하는 알고리즘

가장 낮은 페이지 폴트율을 보인다

다만 현실적으로 구현하기 어려워 다른 알고리즘의 이론상 성능을 평가하기 위한 목적으로 사용된다
## LRU;Least Recently used page replacement algorithm
최근에 사용되지 않은 페이지는 앞으로도 사용되지 않을 것 이라는 아이디를 토대로 만들진 알고리즘이다

가장 오랫동안 사용되지 않은 페이지를 교체하는 알고리즘이다.


# 스래싱과 프레임 할당
## thrashing 
프로세스가 실제 실행되는 시간보다 페이징에 더 많은 시간을 소요하여 성능이 저하되는 문제
## degree of multiprogramming 
메모리에서 동시 실행되는 프로세스의 수를 나타내는것
## 프레임 할당방식
- equal allocation
> 세개의 프로세스에 총 300개의 프레임을 할당할 수 있다면 각 프로세스에 100개의 프로세스를 할당하는 방식. 즉 균등하게 할당한다

- proportional allocation
> 프로세스의 크기가 크면 프레임을 많이 할당하고 프로세스 크기가 작으면 프레임을 적게 나눠 주는 방식

이러한 방식은 프로세스의 실행 과정을 고려하지않고 단순히 프로세스의 크기와 물리 메모리의 크기만을 고려한 방식이라는 점에서 **정적 할당 방식**이라고 한다.

---

**동적 할당 방식**에는 다음과 같은  방식이 있다
- working set model
- PFF;Page-Fault Frequency

## working set model
작업 집합은 실행중인 프로세스가 일정 시간 동안 참조한 페이지의 집합을 의미한다.

작업 집합 모델 기반 프레임 할당은 작업 집합의 크기만큼만 프레임을 할당하는 방식이다.

## PFF
페이지 폴트율 기반 프레임 할당은 페이지 폴트율에 상한선과 하한선을 정하고,그 내부 범위 안에서만 프레임을 할당하는 방식이다.
